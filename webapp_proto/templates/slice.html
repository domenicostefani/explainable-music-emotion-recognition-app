
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Slice {{ slice_label }} - Waveform Viewer</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">&larr; Back</a>
        
        <div class="slice-info">
            <h1>Slice #{{ slice_id }}</h1> <!-- - Detailed View -->
            <h2>Emotion: <span id="emoLabel"></span></h2>

            <div id="overallEmotion" class="overall-emotion">
                <div class="box-vert-flex">
                    <span id="prob_emo0"></span>
                    <span id="prob_emo1"></span>
                    <span id="prob_emo2"></span>
                    <span id="prob_emo3"></span>
                </div>
            </div>
            <p>{{ slice_start }}s-{{ slice_end }}s</p>
            <!-- <p>This shows a zoomed view of the 3-second audio slice labeled "{{ slice_label }}".</p> -->
            <!-- <p><strong>Slice ID:</strong> {{ slice_id }}</p> -->

            <!-- <p><strong>Start Time:</strong> {{ start_time }} seconds</p> -->
            
            <p style="margin-bottom:1px; text-align: center;">Play back the slice</p>
            <audio id="recPlayer" controls class="rec-player">
                <source id="recSource" src="" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
        </div>
        
        <div class="slice-container">
            <img src="data:image/png;base64,{{ plot }}" alt="Waveform Slice {{ slice_label }}" class="slice-img">
            <img src="data:image/png;base64,{{ spectrogram }}" alt="Spectrogram Slice {{ slice_label }}" class="slice-img">
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const recPlayer = document.getElementById("recPlayer");
            const recSource = document.getElementById("recSource");
            // Add #t=3,4.5
            console.log("Audio URL:'{{ audio_url }}'"); // Debugging line to check the audio URL
            // recSource.src = "data:audio/wav;base64,{{ audio_url }}"; // Set the audio source
            recSource.src = "{{ audio_url }}#t={{ slice_start }},{{ slice_end }}"; // Set the audio source
            recPlayer.load();
            recPlayer.style.display = "inline-block"; // Show the audio player

            // Load id emolabel
            const emoLabel = document.getElementById("emoLabel");
            let sliceLabel = "{{ slice_label }}";
            emoLabel.textContent = sliceLabel.charAt(0).toUpperCase() + sliceLabel.slice(1); // Capitalize the first letter


            let sliceEmoProbabilities = "{{ emotion_probabilities }}";
            // Transform this string of a dict back to a dict
            // Replace HTML entities first
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/&#39;/g, "'"); // Replace &#39; with '
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/&quot;/g, '"'); // Replace &quot; with "
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/&amp;/g, '&'); // Replace &amp; with &

            // Convert Python dict format to JSON format
            // Replace single quotes around keys and string values with double quotes
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/'/g, '"');

            console.log("Slice Emotion Probabilities:", sliceEmoProbabilities); // Debugging line to check the emotion probabilities

            const overallEmotionProbs = [
                document.getElementById('prob_emo0'),
                document.getElementById('prob_emo1'),
                document.getElementById('prob_emo2'),
                document.getElementById('prob_emo3')
            ];
            
            let emotionProbabilities = {};
            try {
                // Parse the string to a JSON object
                emotionProbabilities = JSON.parse(sliceEmoProbabilities);
                console.log("Parsed Emotion Probabilities:", emotionProbabilities); // Debugging line to check the parsed emotion probabilities
            } catch (error) {
                console.error("Error parsing JSON:", error);
                console.log("String that failed to parse:", sliceEmoProbabilities);
            }

            // Iterate over the emotion probabilities and display them
            let counter = 0;
            for (const [emotion, prob] of Object.entries(emotionProbabilities || {}))
            {
                console.log(`Emotion: ${emotion}, Probability: ${prob}`); // Debugging line to check each emotion and probability
                // First letter of emotion capitalized
                let emotionPrint = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                let probString = `${emotionPrint}: ${(prob * 100).toFixed(2)}%`;
                overallEmotionProbs[counter].textContent = `${probString || 'N/A'}`;
                counter++;
            }

            // counter = 0;
            // for (const [emotion, prob] of Object.entries(sliceEmoProbabilities || {})) {
            //     // First letter of emotion capitalized
            //     emotionPrint = emotion.charAt(0).toUpperCase() + emotion.slice(1);
            //     console.log(`Emotion: ${emotionPrint}, Probability: ${prob}`); // Debugging line to check each emotion and probability
            //     let probString = `${emotionPrint}: ${(prob * 100).toFixed(2)}%`;
            //     overallEmotionProbs[counter].textContent = `${probString || 'N/A'}`;
            //     counter++;    
            // }
            
        });
    </script>
</body>
</html>
