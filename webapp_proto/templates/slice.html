
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Slice {{ slice_label }} - Waveform Viewer</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">&larr; Back</a>
        
        <div class="slice-info">
            <div class="slice-title">
                <h1>Slice #{{ slice_id }}</h1>
                <span>({{ slice_start }} - {{ slice_end }} seconds)</span>
            </div>
            <h3>This slice was classified: <span id="emoLabel" style="font-weight: bold;"></span></h3>

            <div id="overallEmotion" class="overall-emotion">
                <div class="emotion-display">
                    <!-- <div class="box-vert-flex">
                        <span id="prob_emo0"></span>
                        <span id="prob_emo1"></span>
                        <span id="prob_emo2"></span>
                        <span id="prob_emo3"></span>
                    </div> -->
                    
                    <div class="bar-chart-container">
                        <div class="bar-chart">
                            <div class="bar-item">
                                <div class="bar-label" id="bar_label_0">Emotion 1</div>
                                <div class="bar-background">
                                    <div class="bar-fill emotion-0" id="bar_fill_0" style="width: 0%"></div>
                                    <div class="bar-percentage" id="bar_percentage_0">0%</div>
                                </div>
                            </div>
                            <div class="bar-item">
                                <div class="bar-label" id="bar_label_1">Emotion 2</div>
                                <div class="bar-background">
                                    <div class="bar-fill emotion-1" id="bar_fill_1" style="width: 0%"></div>
                                    <div class="bar-percentage" id="bar_percentage_1">0%</div>
                                </div>
                            </div>
                            <div class="bar-item">
                                <div class="bar-label" id="bar_label_2">Emotion 3</div>
                                <div class="bar-background">
                                    <div class="bar-fill emotion-2" id="bar_fill_2" style="width: 0%"></div>
                                    <div class="bar-percentage" id="bar_percentage_2">0%</div>
                                </div>
                            </div>
                            <div class="bar-item">
                                <div class="bar-label" id="bar_label_3">Emotion 4</div>
                                <div class="bar-background">
                                    <div class="bar-fill emotion-3" id="bar_fill_3" style="width: 0%"></div>
                                    <div class="bar-percentage" id="bar_percentage_3">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p style="margin-bottom:1px; text-align: center;">Play back the slice</p>
            <audio id="recPlayer" controls class="rec-player">
                <source id="recSource" src="" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
        </div>
        
        <div class="slice-container">
            <img src="data:image/png;base64,{{ plot }}" alt="Waveform Slice {{ slice_label }}" class="slice-img">
            <img src="data:image/png;base64,{{ spectrogram }}" alt="Spectrogram Slice {{ slice_label }}" class="slice-img">
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const recPlayer = document.getElementById("recPlayer");
            const recSource = document.getElementById("recSource");
            
            console.log("Audio URL:'{{ audio_url }}'");
            recSource.src = "{{ audio_url }}#t={{ slice_start }},{{ slice_end }}";
            recPlayer.load();
            recPlayer.style.display = "inline-block";

            // Load emotion label
            const emoLabel = document.getElementById("emoLabel");
            let sliceLabel = "{{ slice_label }}";
            emoLabel.textContent = sliceLabel.charAt(0).toUpperCase() + sliceLabel.slice(1);

            let sliceEmoProbabilities = "{{ emotion_probabilities }}";
            // Transform this string of a dict back to a dict
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/&#39;/g, "'");
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/&quot;/g, '"');
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/&amp;/g, '&');
            sliceEmoProbabilities = sliceEmoProbabilities.replace(/'/g, '"');

            console.log("Slice Emotion Probabilities:", sliceEmoProbabilities);

            const overallEmotionProbs = [
                document.getElementById('prob_emo0'),
                document.getElementById('prob_emo1'),
                document.getElementById('prob_emo2'),
                document.getElementById('prob_emo3')
            ];
            
            let emotionProbabilities = {};
            try {
                emotionProbabilities = JSON.parse(sliceEmoProbabilities);
                console.log("Parsed Emotion Probabilities:", emotionProbabilities);
            } catch (error) {
                console.error("Error parsing JSON:", error);
                console.log("String that failed to parse:", sliceEmoProbabilities);
            }

            // Iterate over the emotion probabilities and display them
            let counter = 0;
            for (const [emotion, prob] of Object.entries(emotionProbabilities || {})) {
                console.log(`Emotion: ${emotion}, Probability: ${prob}`);
                
                // First letter of emotion capitalized
                let emotionPrint = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                let probString = `${emotionPrint}: ${(prob * 100).toFixed(2)}%`;
                if (overallEmotionProbs[counter]) {
                    overallEmotionProbs[counter].textContent = probString;
                }
                
                // Update bar chart
                const barLabel = document.getElementById(`bar_label_${counter}`);
                const barFill = document.getElementById(`bar_fill_${counter}`);
                const barPercentage = document.getElementById(`bar_percentage_${counter}`);
                
                if (barLabel && barFill && barPercentage) {
                    barLabel.textContent = emotionPrint;
                    
                    // Animate the bar fill after a short delay
                    setTimeout(() => {
                        barFill.style.width = `${(prob * 100).toFixed(1)}%`;
                    }, 100 + (counter * 100)); // Stagger the animations
                    
                    barPercentage.textContent = `${(prob * 100).toFixed(1)}%`;
                }
                
                counter++;
            }
        });
    </script>
</body>
</html>
